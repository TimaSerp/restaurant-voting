DROP TABLE IF EXISTS user_roles CASCADE;
DROP TABLE IF EXISTS meals CASCADE;
DROP TABLE IF EXISTS restaurant_votes CASCADE;
DROP TABLE IF EXISTS restaurants CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP SEQUENCE IF EXISTS global_seq;

CREATE SEQUENCE global_seq AS INTEGER START WITH 100000;

CREATE TABLE restaurants
(
    id          INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name        VARCHAR(255) NOT NULL,
    description VARCHAR(255) NOT NULL,
    address     VARCHAR(255) NOT NULL
);
CREATE TABLE users
(
    id         INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name       VARCHAR(255)            NOT NULL,
    email      VARCHAR(255)            NOT NULL,
    password   VARCHAR(255)            NOT NULL,
    registered TIMESTAMP DEFAULT now() NOT NULL,
    enabled    BOOLEAN   DEFAULT TRUE  NOT NULL
);
CREATE UNIQUE INDEX users_unique_email_idx
    ON users (email);
CREATE TABLE user_roles
(
    user_id INTEGER      NOT NULL,
    role    VARCHAR(255) NOT NULL,
    CONSTRAINT user_roles_idx UNIQUE (user_id, role),
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
CREATE TABLE restaurant_votes
(
    id            INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id       INTEGER            NOT NULL,
    vote_date     DATE DEFAULT now() NOT NULL,
    restaurant_id INTEGER            NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants (id) ON DELETE CASCADE
);
CREATE UNIQUE INDEX restaurant_votes_unique_vote_per_day_idx
    ON restaurant_votes (vote_date, user_id);
CREATE TABLE meals
(
    id            INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name          VARCHAR(255)       NOT NULL,
    description   VARCHAR(255),
    price         INTEGER            NOT NULL,
    restaurant_id INTEGER            NOT NULL,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants (id) ON DELETE CASCADE
);
CREATE UNIQUE INDEX meals_unique_meal_per_day_idx ON meals (description, restaurant_id);

DELETE
FROM user_roles;
DELETE
FROM meals;
DELETE
FROM restaurants;
DELETE
FROM users;
ALTER SEQUENCE global_seq RESTART WITH 100000;

INSERT INTO users (id, name, email, password)
VALUES (100000, 'User', 'user@yandex.ru', 'password'),
       (100001, 'Admin', 'admin@gmail.com', 'admin'),
       (100002, 'Guest', 'guest@gmail.com', 'guest');

INSERT INTO restaurants (id, name, description, address)
VALUES (100003, 'Чайка', 'Птичий ресторан', 'Улица Пушкина, дом Колотушкина'),
       (100004, 'Форель', 'Рыбный ресторан', 'Окунева авеню, дом 15'),
       (100005, 'Кабанчик', 'Мясной ресторан', 'Свиной проспект, дом 34'),
       (100006, 'Без мяса', 'Веганский ресторан', 'Овощной бульвар, дом 0');

INSERT INTO user_roles (role, user_id)
VALUES ('USER', 100000),
       ('ADMIN', 100001);

INSERT INTO meals (name, price, restaurant_id)
VALUES ('Цыпленок табака', 500, 100003),
       ('Куриный шашлык', 700, 100003),
       ('Овощи на гриле', 600, 100003),
       ('Компот из сухофруктов', 100, 100004),
       ('Форель запеченная', 500, 100004),
       ('Мясная отбивная', 800, 100005),
       ('Гуляш', 500, 100005),
       ('Ризотто с грибами', 500, 100006),
       ('Смузи из манго', 300, 100006);
